<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Recipes & Meal Planning</title>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA2hOiQV4oiMf8YGlXMsK7vMbsdWonAsYE",
    authDomain: "meal-recipe-b7753.firebaseapp.com",
    projectId: "meal-recipe-b7753",
    storageBucket: "meal-recipe-b7753.firebasestorage.app",
    messagingSenderId: "775365507411",
    appId: "1:775365507411:web:eb8406b1d1b27dd6c609a6"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Export to use in HTML script
  window.db = db;
  window.firebaseCollection = collection;
  window.addDoc = addDoc;
  window.getDocs = getDocs;
  window.query = query;
  window.orderBy = orderBy;
</script>

<style>
  body { margin:0; font-family:'Segoe UI',sans-serif; background:#e6f4f1; color:#333; }
  nav { background:#14532d; display:flex; flex-wrap:wrap; justify-content:center; padding:12px 0; }
  nav a { color:white; margin:5px 15px; text-decoration:none; font-weight:bold; }
  nav a.active { text-decoration:underline; }
  .container { max-width:1000px; margin:20px auto; padding:20px; background:white; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
  h1, h2 { text-align:center; color:#14532d; }
  .hidden { display:none; }
  input, textarea { width:100%; padding:10px; margin-top:5px; border:1px solid #ccc; border-radius:6px; }
  button { background:#16a34a; color:white; border:none; padding:10px 16px; border-radius:6px; cursor:pointer; margin-top:10px; }
  button:hover { background:#15803d; }
  ul { list-style:none; padding:0; }
  li { background:#e6f4ea; border-radius:8px; margin-bottom:8px; padding:10px; display:flex; justify-content:space-between; align-items:center; }
  .card { background:#f0fdf4; padding:8px; border-radius:8px; margin:6px 0; cursor:pointer; }
  .calendar { display:grid; grid-template-columns:repeat(7,1fr); gap:8px; margin-top:20px; }
  .day { background:#d1fae5; border-radius:8px; min-height:140px; padding:8px; }
  .day h4 { text-align:center; background:#14532d; color:white; border-radius:4px; padding:4px; margin-top:0; }
  .draggable { background:#4ade80; color:white; border-radius:6px; padding:5px; margin-top:5px; cursor:grab; }
  #recipe-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
  #modal-content { background:white; border-radius:12px; padding:20px; max-width:600px; width:90%; max-height:80vh; overflow-y:auto; }
  #modal-content h3 { color:#14532d; margin-top:0; }
  #close-modal { background:#ef4444; margin-top:10px; }
  .hero { background:url('https://images.unsplash.com/photo-1504674900247-0877df9cc836?auto=format&fit=crop&w=1350&q=80') center/cover no-repeat; height:300px; border-radius:12px; margin-bottom:20px; display:flex; align-items:center; justify-content:center; color:white; text-shadow:2px 2px 4px rgba(0,0,0,0.5); }
  .hero h1 { font-size:2.5em; }
  @media(max-width:768px){ .calendar { grid-template-columns:repeat(2,1fr); } }
  @media(max-width:480px){ .calendar { grid-template-columns:1fr; } nav { flex-direction:column; } }
</style>
</head>
<body>

<nav>
  <a href="#" id="nav-home" onclick="showSection('home')">Home</a>
  <a href="#" id="nav-add" onclick="showSection('add')">Add Recipe</a>
  <a href="#" id="nav-book" onclick="showSection('book')">Recipe Book</a>
  <a href="#" id="nav-meal" onclick="showSection('meal')">Meal Planner</a>
</nav>

<div class="container">

  <!-- Home -->
  <section id="home-section">
    <div class="hero">
      <h1>Recipes & Meal Planning</h1>
    </div>
    <p style="text-align:center;">Organize, save, and plan your meals for the week with beautiful recipes and fine cuisine images.</p>
  </section>

  <!-- Add Recipe -->
  <section id="add-section" class="hidden">
    <h2>Add Recipe</h2>
    <form id="add-form">
      <label>Title</label>
      <input type="text" id="add-title" required>
      <label>Ingredients (one per line)</label>
      <textarea id="add-ingredients" rows="4" required></textarea>
      <label>Instructions</label>
      <textarea id="add-instructions" rows="5" required></textarea>
      <label>Upload Image</label>
      <input type="file" id="add-image" accept="image/*">
      <button type="submit">Add Recipe</button>
    </form>
  </section>

  <!-- Recipe Book -->
  <section id="book-section" class="hidden">
    <h2>Recipe Book</h2>
    <ul id="recipe-list"></ul>
    <div id="no-recipes" style="text-align:center;color:#777;">No recipes yet. Add one!</div>
  </section>

  <!-- Meal Planner -->
  <section id="meal-section" class="hidden">
    <h2>Weekly Meal Planner</h2>
    <p style="text-align:center;">Drag recipes into each day. Double-click to remove.</p>
    <div class="calendar" id="calendar">
      <div class="day" data-day="Monday"><h4>Monday</h4></div>
      <div class="day" data-day="Tuesday"><h4>Tuesday</h4></div>
      <div class="day" data-day="Wednesday"><h4>Wednesday</h4></div>
      <div class="day" data-day="Thursday"><h4>Thursday</h4></div>
      <div class="day" data-day="Friday"><h4>Friday</h4></div>
      <div class="day" data-day="Saturday"><h4>Saturday</h4></div>
      <div class="day" data-day="Sunday"><h4>Sunday</h4></div>
    </div>
    <h3 style="margin-top:30px;">Your Recipes</h3>
    <div id="recipe-pool"></div>
    <button onclick="clearCalendar()">Clear Calendar</button>
  </section>

</div>

<!-- Modal -->
<div id="recipe-modal">
  <div id="modal-content">
    <h3 id="modal-title"></h3>
    <h4>Ingredients</h4>
    <ul id="modal-ingredients"></ul>
    <h4>Instructions</h4>
    <p id="modal-instructions"></p>
    <button id="close-modal">Close</button>
  </div>
</div>

<script type="module">
  import { db, firebaseCollection, addDoc, getDocs, query, orderBy } from './'; // Using window exports

  let recipes = [];
  let mealPlan = {};

  async function loadRecipesFromFirestore(){
    const q = query(firebaseCollection(db, "recipes"), orderBy("timestamp","desc"));
    const snapshot = await getDocs(q);
    recipes = snapshot.docs.map(doc=>({ id: doc.id, ...doc.data() }));
  }

  function saveMealPlan() { localStorage.setItem('mealPlan', JSON.stringify(mealPlan)); }
  function loadMealPlan() { mealPlan = JSON.parse(localStorage.getItem('mealPlan')) || {}; }

  async function showSection(name){
    ['home','add','book','meal'].forEach(s=>{
      document.getElementById(s+'-section').classList.add('hidden');
      document.getElementById('nav-'+s)?.classList.remove('active');
    });
    document.getElementById(name+'-section').classList.remove('hidden');
    document.getElementById('nav-'+name)?.classList.add('active');

    if(name==='book' || name==='meal'){
      await loadRecipesFromFirestore();
      if(name==='book') renderBook();
      if(name==='meal') renderMealPlanner();
    }
  }

  document.getElementById('add-form').addEventListener('submit', async e=>{
    e.preventDefault();
    const title=document.getElementById('add-title').value.trim();
    const ingredients=document.getElementById('add-ingredients').value.trim();
    const instructions=document.getElementById('add-instructions').value.trim();
    const file=document.getElementById('add-image').files[0];

    let reader=null;
    if(file){
      reader=new FileReader();
      reader.readAsDataURL(file);
      await new Promise(res=>reader.onload=()=>res());
    }

    const recipeData = { title, ingredients, instructions, image: reader? reader.result : null, timestamp: Date.now() };
    try{
      await addDoc(firebaseCollection(db,"recipes"),recipeData);
      alert("Recipe saved online!");
      e.target.reset();
      await loadRecipesFromFirestore();
    }catch(err){console.error(err);}
  });

  function renderBook(){
    const list=document.getElementById('recipe-list');
    const noRecipes=document.getElementById('no-recipes');
    list.innerHTML='';
    if(recipes.length===0){ noRecipes.style.display='block'; return; }
    noRecipes.style.display='none';

    recipes.forEach(r=>{
      const li=document.createElement('li');
      li.innerHTML=`
        <span onclick="openRecipe('${r.id}')" style="cursor:pointer;font-weight:bold;">${r.title}</span>
      `;
      if(r.image) {
        const img=document.createElement('img');
        img.src=r.image;
        img.style.height='50px';
        img.style.marginLeft='10px';
        li.appendChild(img);
      }
      list.appendChild(li);
    });
  }

  function openRecipe(id){
    const r=recipes.find(x=>x.id===id);
    if(!r) return;
    document.getElementById('modal-title').textContent=r.title;
    document.getElementById('modal-ingredients').innerHTML=r.ingredients.split('\n').map(i=>`<li>${i}</li>`).join('');
    document.getElementById('modal-instructions').textContent=r.instructions;
    document.getElementById('recipe-modal').style.display='flex';
  }

  document.getElementById('close-modal').onclick=()=>document.getElementById('recipe-modal').style.display='none';
  window.onclick=(e)=>{if(e.target.id==='recipe-modal')document.getElementById('recipe-modal').style.display='none';};

  function renderMealPlanner(){
    loadMealPlan();
    const pool=document.getElementById('recipe-pool');
    pool.innerHTML='';
    recipes.forEach(r=>{
      const div=document.createElement('div');
      div.className='draggable';
      div.textContent=r.title;
      div.dataset.id=r.id;
      div.draggable=true;
      div.addEventListener('dragstart', e=>e.dataTransfer.setData('text/plain', r.id));
      pool.appendChild(div);
    });

    document.querySelectorAll('.day').forEach(day=>{
      day.innerHTML=`<h4>${day.dataset.day}</h4>`;
      const meals=mealPlan[day.dataset.day]||[];
      meals.forEach(rid=>{
        const recipe=recipes.find(r=>r.id===rid);
        if(recipe){
          const card=document.createElement('div');
          card.className='card';
          card.textContent=recipe.title;
          card.ondblclick=()=>{ mealPlan[day.dataset.day]=mealPlan[day.dataset.day].filter(i=>i!==rid); saveMealPlan(); renderMealPlanner(); };
          day.appendChild(card);
        }
      });
      day.addEventListener('dragover', e=>e.preventDefault());
      day.addEventListener('drop', e=>{
        const rid=e.dataTransfer.getData('text/plain');
        if(!mealPlan[day.dataset.day]) mealPlan[day.dataset.day]=[];
        mealPlan[day.dataset.day].push(rid);
        saveMealPlan();
        renderMealPlanner();
      });
    });
  }

  function clearCalendar(){ if(confirm("Clear all meals?")){ mealPlan={}; saveMealPlan(); renderMealPlanner(); } }

  showSection('home');
</script>
</body>
</html>
